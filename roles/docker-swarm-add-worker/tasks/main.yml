---
- name: check if swarm is already initialized
  shell: docker info
  changed_when: false
  register: docker_info

- name: add workers to the swarm
  vars:
    token: "{{ hostvars[groups['controller'][0]]['worker_token']['stdout'] }}"
    controller: "{{ hostvars[groups['controller'][0]]['inventory_hostname'] }}"
  shell: "docker swarm join --token {{ token }} {{ controller }}:2377"
  when: "docker_info.stdout.find('Swarm: active') == -1
    and docker_info.stdout.find('Swarm: pending') == -1"
